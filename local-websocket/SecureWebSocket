// secure_bridge.mjs
// Run: node secure_bridge.mjs
// Node.js >=16 recommended

import fs from 'fs';
import https from 'https';
import WebSocket, { WebSocketServer } from 'ws';
import path from 'path';
import url from 'url';

// ------------------ CONFIG ------------------
const PORT = 8080;
const LOCAL_SERVER_SECRET = process.env.LOCAL_SERVER_SECRET || "supersecret_token"; // token for clients

// ---------- EMOTIV CONFIG ----------
const EMOTIV_WSS = 'wss://localhost:6868';
const EMOTIV_CLIENT_ID = process.env.EMOTIV_CLIENT_ID || 'YOUR_CLIENT_ID';
const EMOTIV_CLIENT_SECRET = process.env.EMOTIV_CLIENT_SECRET || 'YOUR_CLIENT_SECRET';

// ------------- CERT SPOT -------------------
// Place your Emotiv certificate (from Emotiv Cortex local install) in the same folder
// e.g., ./emotiv_cert.pem
const EMOTIV_CERT_PATH = path.resolve('./emotiv_cert.pem');
// -------------------------------------------

// Load Emotiv certificate
const emotivCert = fs.readFileSync(EMOTIV_CERT_PATH);

// Create HTTPS Agent that trusts Emotiv cert only
const agent = new https.Agent({
    rejectUnauthorized: true,
    ca: emotivCert,
});

// ---------- LOCAL WSS SERVER ----------
const server = https.createServer({}, (req, res) => {
    if (req.url === '/health') {
        res.writeHead(200, { 'Content-Type': 'text/plain' });
        res.end('ok');
    } else {
        res.writeHead(404);
        res.end();
    }
});

server.listen(PORT, () => {
    console.log(`Local WSS server running at wss://localhost:${PORT}`);
});

const wss = new WebSocketServer({
    server,
    clientTracking: true,
    verifyClient: (info, done) => {
        // Simple token check
        const query = url.parse(info.req.url, true).query;
        if (query.token === LOCAL_SERVER_SECRET) done(true);
        else done(false, 401, "Unauthorized");
    }
});

// Broadcast function (send data to all connected clients)
function broadcast(data) {
    const payload = JSON.stringify(data);
    for (const client of wss.clients) {
        if (client.readyState === WebSocket.OPEN) {
            client.send(payload);
        }
    }
}

// Handle client connections
wss.on('connection', (ws) => {
    console.log('Client connected');

    ws.isAlive = true;
    ws.on('pong', () => ws.isAlive = true);

    ws.on('message', (msg) => {
        // Disallow arbitrary commands for security
        console.log('Received message from client (ignored):', msg.toString().slice(0, 100));
    });

    ws.on('close', () => console.log('Client disconnected'));
});

// Heartbeat to terminate dead clients
setInterval(() => {
    wss.clients.forEach(ws => {
        if (!ws.isAlive) return ws.terminate();
        ws.isAlive = false;
        ws.ping(() => {});
    });
}, 30000);

// ---------- EMOTIV CONNECTION ----------
let emotivWS = null;
let cortexToken = null;
let sessionId = null;

let requestId = 1;
function nextId() { return requestId++; }

function sendToEmotiv(obj) {
    if (!emotivWS || emotivWS.readyState !== WebSocket.OPEN) return;
    emotivWS.send(JSON.stringify(obj));
}

function connectToEmotiv() {
    console.log('Connecting to Emotiv Cortex...');

    emotivWS = new WebSocket(EMOTIV_WSS, { agent });

    emotivWS.on('open', () => {
        console.log('Connected to Emotiv Cortex');

        // Request access
        sendToEmotiv({
            id: nextId(),
            jsonrpc: '2.0',
            method: 'requestAccess',
            params: { clientId: EMOTIV_CLIENT_ID, clientSecret: EMOTIV_CLIENT_SECRET }
        });

        // Authorize to get token
        sendToEmotiv({
            id: nextId(),
            jsonrpc: '2.0',
            method: 'authorize',
            params: { clientId: EMOTIV_CLIENT_ID, clientSecret: EMOTIV_CLIENT_SECRET }
        });
    });

    emotivWS.on('message', (raw) => {
        let msg;
        try { msg = JSON.parse(raw); } catch { return; }

        // Handle Cortex token
        if (msg.result && msg.result.cortexToken) {
            cortexToken = msg.result.cortexToken;
            console.log('Received cortexToken (hidden for security)');

            // Create a session
            sendToEmotiv({
                id: nextId(),
                jsonrpc: '2.0',
                method: 'createSession',
                params: { cortexToken, status: 'active' }
            });
        }

        // Handle session creation
        if (msg.result && msg.result.id) {
            sessionId = msg.result.id;
            console.log('Session created with id:', sessionId);

            // Subscribe to EEG stream
            sendToEmotiv({
                id: nextId(),
                jsonrpc: '2.0',
                method: 'subscribe',
                params: { cortexToken, session: sessionId, streams: ['eeg'] }
            });
        }

        // Handle EEG stream messages
        if (msg.method === 'stream') {
            const eegData = {
                type: 'eeg',
                timestamp: msg.params.time || Date.now(),
                data: msg.params.data || msg.params
            };
            broadcast(eegData);
        }
    });

    emotivWS.on('close', () => {
        console.warn('Emotiv socket closed, reconnecting in 2s...');
        cortexToken = null;
        sessionId = null;
        setTimeout(connectToEmotiv, 2000);
    });

    emotivWS.on('error', (err) => console.error('Emotiv error:', err.message));
}

connectToEmotiv();

// Graceful shutdown
process.on('SIGINT', () => {
    console.log('Shutting down...');
    emotivWS && emotivWS.close();
    wss && wss.close();
    server && server.close();
    process.exit(0);
});
